<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="K7thEgdLm0UfRWJ5MGdF7sCcjClSzAlxFLPv2Oz5CGM"><title> ejabberd源码分析 · 会飞的鱼</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="ejabberd源码分析 - null"><meta name="keywords"><meta name="author"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="会飞的鱼"></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="博文" class="nav-list-link">博文</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/about/" target="_self" data-hover="关于" class="nav-list-link">关于</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">ejabberd源码分析</h1><div class="post-info">2019-03-07<p class="visit"><i data-hk-page="current">-</i><span>次访问</span></p></div><div class="post-content"><h3 id="ejabberd19-2源码分析"><a href="#ejabberd19-2源码分析" class="headerlink" title="ejabberd19.2源码分析"></a>ejabberd19.2源码分析</h3><h4 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h4><ul>
<li><p>./autogen.sh</p>
<p>./autogen.sh: line 2: aclocal: command not found</p>
<p>./autogen.sh: line 3: autoconf: command not found</p>
<p>解决：yum -y install automake</p>
</li>
<li><p>./configure –enable-user=ejabberd –enable-lager</p>
</li>
<li><p>error: libexpat header file expat.h was not found</p>
<p>解决：yum install expat-devel</p>
</li>
<li><p>configure: error: libyaml header file yaml.h was not found</p>
<p>解决：yum install libyaml-devel</p>
</li>
</ul>
<h4 id="ejabberd认证"><a href="#ejabberd认证" class="headerlink" title="ejabberd认证"></a>ejabberd认证</h4><p>&lt;&lt;”DIGEST-MD5”&gt;&gt;,&lt;&lt;”PLAIN”&gt;&gt;,&lt;&lt;”SCRAM-SHA-1”&gt;&gt;,&lt;&lt;”X-OAUTH2”&gt;&gt;</p>
<p>xml流处理：xmpp_stream_in:process_element:589</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-spec</span> process_element<span class="params">(xmpp_element(), state())</span> -&gt; state<span class="params">()</span>.</span><br><span class="line"><span class="function"><span class="title">process_element</span><span class="params">(Pkt, #&#123;stream_state := StateName, lang := Lang&#125; = State)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> Pkt <span class="keyword">of</span></span><br><span class="line">    #starttls&#123;&#125; <span class="keyword">when</span> StateName == wait_for_starttls;</span><br><span class="line">             StateName == wait_for_sasl_request -&gt;</span><br><span class="line">        process_starttls(State);</span><br><span class="line">    #starttls&#123;&#125; -&gt;</span><br><span class="line">        process_starttls_failure(unexpected_starttls_request, State);</span><br><span class="line">    #sasl_auth&#123;&#125; <span class="keyword">when</span> StateName == wait_for_starttls -&gt;</span><br><span class="line">        send_pkt(State, #sasl_failure&#123;reason = 'encryption-required'&#125;);</span><br><span class="line">    #sasl_auth&#123;&#125; <span class="keyword">when</span> StateName == wait_for_sasl_request -&gt;</span><br><span class="line">        process_sasl_request(Pkt, State);</span><br><span class="line">    #sasl_auth&#123;&#125; <span class="keyword">when</span> StateName == wait_for_sasl_response -&gt;</span><br><span class="line">        process_sasl_request(Pkt, maps:remove(sasl_state, State));</span><br><span class="line">    #sasl_auth&#123;&#125; -&gt;</span><br><span class="line">        Txt = &lt;&lt;<span class="string">"SASL negotiation is not allowed in this state"</span>&gt;&gt;,</span><br><span class="line">        send_pkt(State, #sasl_failure&#123;reason = 'not-authorized',</span><br><span class="line">                          text = xmpp:mk_text(Txt, Lang)&#125;);</span><br><span class="line">    #sasl_response&#123;&#125; <span class="keyword">when</span> StateName == wait_for_starttls -&gt;</span><br><span class="line">        send_pkt(State, #sasl_failure&#123;reason = 'encryption-required'&#125;);</span><br><span class="line">    #sasl_response&#123;&#125; <span class="keyword">when</span> StateName == wait_for_sasl_response -&gt;</span><br><span class="line">        process_sasl_response(Pkt, State);</span><br><span class="line">    #sasl_response&#123;&#125; -&gt;</span><br><span class="line">        Txt = &lt;&lt;<span class="string">"SASL negotiation is not allowed in this state"</span>&gt;&gt;,</span><br><span class="line">        send_pkt(State, #sasl_failure&#123;reason = 'not-authorized',</span><br><span class="line">                          text = xmpp:mk_text(Txt, Lang)&#125;);</span><br><span class="line">    #sasl_abort&#123;&#125; <span class="keyword">when</span> StateName == wait_for_sasl_response -&gt;</span><br><span class="line">        process_sasl_abort(State);</span><br><span class="line">    #sasl_abort&#123;&#125; -&gt;</span><br><span class="line">        send_pkt(State, #sasl_failure&#123;reason = 'aborted'&#125;);</span><br><span class="line">    #sasl_success&#123;&#125; -&gt;</span><br><span class="line">        State;</span><br><span class="line">    #compress&#123;&#125; -&gt;</span><br><span class="line">        process_compress(Pkt, State);</span><br><span class="line">    #handshake&#123;&#125; <span class="keyword">when</span> StateName == wait_for_handshake -&gt;</span><br><span class="line">        process_handshake(Pkt, State);</span><br><span class="line">    #handshake&#123;&#125; -&gt;</span><br><span class="line">        State;</span><br><span class="line">    #stream_error&#123;&#125; -&gt;</span><br><span class="line">        process_stream_end(&#123;stream, &#123;in, Pkt&#125;&#125;, State);</span><br><span class="line">    _ <span class="keyword">when</span> StateName == wait_for_sasl_request;</span><br><span class="line">           StateName == wait_for_handshake;</span><br><span class="line">           StateName == wait_for_sasl_response -&gt;</span><br><span class="line">        process_unauthenticated_packet(Pkt, State);</span><br><span class="line">    _ <span class="keyword">when</span> StateName == wait_for_starttls -&gt;</span><br><span class="line">        Txt = &lt;&lt;<span class="string">"Use of STARTTLS required"</span>&gt;&gt;,</span><br><span class="line">        Err = xmpp:serr_policy_violation(Txt, Lang),</span><br><span class="line">        send_pkt(State, Err);</span><br><span class="line">    _ <span class="keyword">when</span> StateName == wait_for_bind -&gt;</span><br><span class="line">        process_bind(Pkt, State);</span><br><span class="line">    _ <span class="keyword">when</span> StateName == established -&gt;</span><br><span class="line">        process_authenticated_packet(Pkt, State)</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>
<p>认证逻辑：xmpp_stream_in:process_sasl_request:817</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-spec</span> process_sasl_request<span class="params">(sasl_auth(), state())</span> -&gt; state<span class="params">()</span>.</span><br><span class="line"><span class="function"><span class="title">process_sasl_request</span><span class="params">(#sasl_auth&#123;mechanism = Mech, text = ClientIn&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">             #&#123;lserver := LServer&#125; = State)</span> -&gt;</span></span><br><span class="line">    State1 = State#&#123;sasl_mech =&gt; Mech&#125;,</span><br><span class="line">    Mechs = get_sasl_mechanisms(State1),</span><br><span class="line">    <span class="keyword">case</span> lists:member(Mech, Mechs) <span class="keyword">of</span></span><br><span class="line">    <span class="literal">true</span> <span class="keyword">when</span> Mech == &lt;&lt;<span class="string">"EXTERNAL"</span>&gt;&gt; -&gt;</span><br><span class="line">        Res = <span class="keyword">case</span> xmpp_stream_pkix:authenticate(State1, ClientIn) <span class="keyword">of</span></span><br><span class="line">              &#123;ok, Peer&#125; -&gt;</span><br><span class="line">              &#123;ok, [&#123;auth_module, pkix&#125;, &#123;username, Peer&#125;]&#125;;</span><br><span class="line">              &#123;error, Reason, Peer&#125; -&gt;</span><br><span class="line">              &#123;error, Reason, Peer&#125;</span><br><span class="line">          <span class="keyword">end</span>,</span><br><span class="line">        process_sasl_result(Res, State1);</span><br><span class="line">    <span class="literal">true</span> -&gt;</span><br><span class="line">        GetPW = get_password_fun(Mech, State1),</span><br><span class="line">        CheckPW = check_password_fun(Mech, State1),</span><br><span class="line">        CheckPWDigest = check_password_digest_fun(Mech, State1),</span><br><span class="line">        SASLState = xmpp_sasl:server_new(LServer, GetPW, CheckPW, CheckPWDigest),</span><br><span class="line">        Res = xmpp_sasl:server_start(SASLState, Mech, ClientIn),</span><br><span class="line">        process_sasl_result(Res, State1#&#123;sasl_state =&gt; SASLState&#125;);</span><br><span class="line">    <span class="literal">false</span> -&gt;</span><br><span class="line">        process_sasl_result(&#123;error, unsupported_mechanism, &lt;&lt;<span class="string">""</span>&gt;&gt;&#125;, State1)</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>
<h4 id="资源绑定"><a href="#资源绑定" class="headerlink" title="资源绑定"></a>资源绑定</h4><p>xmpp_stream_in:process_bind:666</p>
<p>ejabberd_c2s:bind:393</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">bind</span><span class="params">(R, #&#123;user := U, server := S, access := Access, lang := Lang,</span></span></span><br><span class="line"><span class="function"><span class="params">      lserver := LServer, socket := Socket,</span></span></span><br><span class="line"><span class="function"><span class="params">      ip := IP&#125; = State)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> resource_conflict_action(U, S, R) <span class="keyword">of</span></span><br><span class="line">    closenew -&gt;</span><br><span class="line">        &#123;error, xmpp:err_conflict(), State&#125;;</span><br><span class="line">    &#123;accept_resource, Resource&#125; -&gt;</span><br><span class="line">        JID = jid:make(U, S, Resource),</span><br><span class="line">        <span class="keyword">case</span> acl:access_matches(Access,</span><br><span class="line">                    #&#123;usr =&gt; jid:split(JID), ip =&gt; IP&#125;,</span><br><span class="line">                    LServer) <span class="keyword">of</span></span><br><span class="line">        allow -&gt;</span><br><span class="line">            State1 = open_session(State#&#123;resource =&gt; Resource,</span><br><span class="line">                         sid =&gt; ejabberd_sm:make_sid()&#125;),</span><br><span class="line">            State2 = ejabberd_hooks:run_fold(</span><br><span class="line">                   c2s_session_opened, LServer, State1, []),</span><br><span class="line">            ?INFO_MSG(<span class="string">"(~s) Opened c2s session for ~s"</span>,</span><br><span class="line">                  [xmpp_socket:pp(Socket), jid:encode(JID)]),</span><br><span class="line">            &#123;ok, State2&#125;;</span><br><span class="line">        deny -&gt;</span><br><span class="line">            ejabberd_hooks:run(forbidden_session_hook, LServer, [JID]),</span><br><span class="line">            ?WARNING_MSG(<span class="string">"(~s) Forbidden c2s session for ~s"</span>,</span><br><span class="line">                 [xmpp_socket:pp(Socket), jid:encode(JID)]),</span><br><span class="line">            Txt = &lt;&lt;<span class="string">"Access denied by service policy"</span>&gt;&gt;,</span><br><span class="line">            &#123;error, xmpp:err_not_allowed(Txt, Lang), State&#125;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>
<p>ejabberd_c2s:open_session:198 -&gt; ejabberd_sm:open_session:154</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">open_session</span><span class="params">(SID, User, Server, Resource, Priority, Info)</span> -&gt;</span></span><br><span class="line">    set_session(SID, User, Server, Resource, Priority, Info),</span><br><span class="line">    check_for_sessions_to_replace(User, Server, Resource),</span><br><span class="line">    JID = jid:make(User, Server, Resource),</span><br><span class="line">    ejabberd_hooks:run(sm_register_connection_hook,</span><br><span class="line">               JID#jid.lserver, [SID, JID, Info]).</span><br></pre></td></tr></table></figure>
<p>set_session函数可以根据配置把session信息存入不同介质（mnesia，redis，sql）配置选项：sm_db_type</p>
<h4 id="数据流"><a href="#数据流" class="headerlink" title="数据流"></a>数据流</h4><ul>
<li><p>监听进程创建c2s事例</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%ejabberd_listener:accept:238 module:ejabberd_c2s, socket:#Port&lt;0.129638&gt;, option:[&#123;access,c2s&#125;,&#123;shaper,c2s_shaper&#125;,&#123;max_stanza_size,262144&#125;],sup:ejabberd_c2s_sup</span></span><br><span class="line"><span class="function"><span class="title">start_connection</span><span class="params">(Module, Socket, Opts, Sup)</span> -&gt;</span></span><br><span class="line">    Res = <span class="keyword">case</span> Sup <span class="keyword">of</span></span><br><span class="line">          undefined -&gt; Module:start(&#123;gen_tcp, Socket&#125;, Opts);</span><br><span class="line">          _ -&gt; supervisor:start_child(Sup, [&#123;gen_tcp, Socket&#125;, Opts])</span><br><span class="line">      <span class="keyword">end</span>,</span><br><span class="line">    <span class="keyword">case</span> Res <span class="keyword">of</span></span><br><span class="line">    &#123;ok, Pid&#125; -&gt;</span><br><span class="line">        <span class="comment">%移交对socket的控制权</span></span><br><span class="line">        <span class="keyword">case</span> gen_tcp:controlling_process(Socket, Pid) <span class="keyword">of</span></span><br><span class="line">        ok -&gt;</span><br><span class="line">            <span class="comment">%调用ejabberd_c2s:appept -&gt; xmpp_stream_in:accept(Ref).</span></span><br><span class="line">            Module:accept(Pid),</span><br><span class="line">            &#123;ok, Pid&#125;;</span><br><span class="line">        Err -&gt;</span><br><span class="line">            exit(Pid, kill),</span><br><span class="line">            Err</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">    Err -&gt;</span><br><span class="line">        Err</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>c2s事例创建分析：使用-behaviour(xmpp_stream_in).</p>
<p>xmpp_stream_in又使用-behaviour(p1_server).</p>
<p>在p1_server模块loop -&gt; process_message -&gt; collect_messages -&gt; decode_msg -&gt; handle_msg</p>
<p>handle_msg有三种类型：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">dispatch</span><span class="params">(&#123;'$gen_cast', Msg&#125;, Mod, State)</span> -&gt;</span></span><br><span class="line">    Mod:handle_cast(Msg, State);</span><br><span class="line"><span class="function"><span class="title">dispatch</span><span class="params">(Info, Mod, State)</span> -&gt;</span> <span class="comment">%这里会接收到Tcp类型的消息，事例：&#123;tcp,#Port&lt;0.129638&gt;,&lt;&lt;"&lt;stream:stream to=\"localhost\" xmlns=\"jabber:client\" xmlns:stream=\"http://etherx.jabber.org/streams\" version=\"1.0\"&gt;"&gt;&gt;&#125;，这里的Mod:xmpp_stream_in</span></span><br><span class="line">    Mod:handle_info(Info, State).</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">handle_msg</span><span class="params">(&#123;'$gen_call', From, Msg&#125;, Parent, Name, State, Mod,</span></span></span><br><span class="line"><span class="function"><span class="params">       Limits, Queue, QueueLen)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">catch</span> Mod:handle_call(Msg, From, State) <span class="keyword">of</span></span><br><span class="line">    &#123;reply, Reply, NState&#125; -&gt;</span><br><span class="line">        reply(From, Reply),</span><br><span class="line">        loop(Parent, Name, NState, Mod, infinity, [],</span><br><span class="line">                 Limits, Queue, QueueLen);</span><br><span class="line">    &#123;reply, Reply, NState, Time1&#125; -&gt;</span><br><span class="line">        reply(From, Reply),</span><br><span class="line">        loop(Parent, Name, NState, Mod, Time1, [],</span><br><span class="line">                 Limits, Queue, QueueLen);</span><br><span class="line">    &#123;noreply, NState&#125; -&gt;</span><br><span class="line">        loop(Parent, Name, NState, Mod, infinity, [],</span><br><span class="line">                 Limits, Queue, QueueLen);</span><br><span class="line">    &#123;noreply, NState, Time1&#125; -&gt;</span><br><span class="line">        loop(Parent, Name, NState, Mod, Time1, [],</span><br><span class="line">                 Limits, Queue, QueueLen);</span><br><span class="line">    &#123;stop, Reason, Reply, NState&#125; -&gt;</span><br><span class="line">        &#123;'EXIT', R&#125; = </span><br><span class="line">        (<span class="keyword">catch</span> terminate(Reason, Name, Msg, Mod, NState, [], Queue)),</span><br><span class="line">        reply(From, Reply),</span><br><span class="line">        exit(R);</span><br><span class="line">    Other -&gt; handle_common_reply(Other, Parent, Name, Msg, Mod, State,</span><br><span class="line">                                     Limits, Queue, QueueLen)</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"><span class="function"><span class="title">handle_msg</span><span class="params">(Msg, Parent, Name, State, Mod,</span></span></span><br><span class="line"><span class="function"><span class="params">       Limits, Queue, QueueLen)</span> -&gt;</span></span><br><span class="line">    Reply = (<span class="keyword">catch</span> dispatch(Msg, Mod, State)),</span><br><span class="line">    handle_common_reply(Reply, Parent, Name, Msg, Mod, State,</span><br><span class="line">                        Limits, Queue, QueueLen).</span><br></pre></td></tr></table></figure>
<p>xmpp_stream_in:handle_info:381</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%完成对Tcp消息的解析xmpp_socket:recv -&gt; parse:383行 -&gt; fxml_stream:parse  这里使用了c的代码，会将tcp消息转成gen_event，这条转换的消息最早也是在p1_server模块loop -&gt; process_message -&gt; collect_messages -&gt; decode_msg -&gt; handle_msg接收的，事例：&#123;'$gen_event',&#123;xmlstreamstart,&lt;&lt;"stream:stream"&gt;&gt;,[&#123;&lt;&lt;"xmlns"&gt;&gt;,&lt;&lt;"jabber:client"&gt;&gt;&#125;,&#123;&lt;&lt;"xmlns:stream"&gt;&gt;,&lt;&lt;"http://etherx.jabber.org/streams"&gt;&gt;&#125;,&#123;&lt;&lt;"to"&gt;&gt;,&lt;&lt;"localhost"&gt;&gt;&#125;,&#123;&lt;&lt;"version"&gt;&gt;,&lt;&lt;"1.0"&gt;&gt;&#125;]&#125;&#125; </span></span><br><span class="line"><span class="function"><span class="title">handle_info</span><span class="params">(&#123;tcp, _, Data&#125;, #&#123;socket := Socket&#125; = State)</span> -&gt;</span></span><br><span class="line">    noreply(</span><br><span class="line">      <span class="keyword">case</span> xmpp_socket:recv(Socket, Data) <span class="keyword">of</span></span><br><span class="line">      &#123;ok, NewSocket&#125; -&gt;</span><br><span class="line">          State#&#123;socket =&gt; NewSocket&#125;;</span><br><span class="line">      &#123;error, Reason&#125; <span class="keyword">when</span> is_atom(Reason) -&gt;</span><br><span class="line">          process_stream_end(&#123;socket, Reason&#125;, State);</span><br><span class="line">      &#123;error, Reason&#125; -&gt;</span><br><span class="line">          <span class="comment">%% <span class="doctag">TODO:</span> make fast_tls return atoms</span></span><br><span class="line">          process_stream_end(&#123;tls, Reason&#125;, State)</span><br><span class="line">      <span class="keyword">end</span>);</span><br></pre></td></tr></table></figure>
<p>当gen_event消息再次到达xmpp_stream_in:handle_info:343</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">%gen_event消息在执行钩子函数后-&gt;process_element -&gt;process_element(Pkt, #&#123;stream_state := StateName, lang := Lang&#125; = State):589 在这里完成认证bind等操作，当StateName == established时，iq_session、iq_roster 协议都会调用process_authenticated_packet -&gt; ejabberd_c2s:handle_authenticated_packet：469  </span></span><br><span class="line"><span class="function"><span class="title">handle_info</span><span class="params">(&#123;'$gen_event', &#123;xmlstreamelement, El&#125;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">        #&#123;xmlns := NS, codec_options := Opts&#125; = State)</span> -&gt;</span></span><br><span class="line">    noreply(</span><br><span class="line">      <span class="keyword">try</span> xmpp:decode(El, NS, Opts) <span class="keyword">of</span></span><br><span class="line">      Pkt -&gt;</span><br><span class="line">          <span class="comment">%回调钩子函数进入c2s模块的handle_recv</span></span><br><span class="line">          State1 = <span class="keyword">try</span> callback(handle_recv, El, Pkt, State)</span><br><span class="line">               <span class="keyword">catch</span> _:&#123;?MODULE, undef&#125; -&gt; State</span><br><span class="line">               <span class="keyword">end</span>,</span><br><span class="line">          <span class="keyword">case</span> is_disconnected(State1) <span class="keyword">of</span></span><br><span class="line">          <span class="literal">true</span> -&gt; State1;</span><br><span class="line">          <span class="literal">false</span> -&gt; process_element(Pkt, State1)</span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">catch</span> _:&#123;xmpp_codec, Why&#125; -&gt;</span><br><span class="line">          State1 = <span class="keyword">try</span> callback(handle_recv, El, &#123;error, Why&#125;, State)</span><br><span class="line">               <span class="keyword">catch</span> _:&#123;?MODULE, undef&#125; -&gt; State</span><br><span class="line">               <span class="keyword">end</span>,</span><br><span class="line">          <span class="keyword">case</span> is_disconnected(State1) <span class="keyword">of</span></span><br><span class="line">          <span class="literal">true</span> -&gt; State1;</span><br><span class="line">          <span class="literal">false</span> -&gt; process_invalid_xml(State1, El, Why)</span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span>);</span><br></pre></td></tr></table></figure>
<p>ejabberd_c2s:handle_authenticated_packet</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">handle_authenticated_packet</span><span class="params">(Pkt, #&#123;lserver := LServer, jid := JID,</span></span></span><br><span class="line"><span class="function"><span class="params">                   ip := &#123;IP, _&#125;&#125; = State)</span> -&gt;</span></span><br><span class="line">    Pkt1 = xmpp:put_meta(Pkt, ip, IP),</span><br><span class="line">    State1 = ejabberd_hooks:run_fold(c2s_authenticated_packet,</span><br><span class="line">                     LServer, State, [Pkt1]),</span><br><span class="line">    #jid&#123;luser = LUser&#125; = JID,</span><br><span class="line">    &#123;Pkt2, State2&#125; = ejabberd_hooks:run_fold(</span><br><span class="line">               user_send_packet, LServer, &#123;Pkt1, State1&#125;, []),</span><br><span class="line">    <span class="keyword">case</span> Pkt2 <span class="keyword">of</span></span><br><span class="line">    drop -&gt;</span><br><span class="line">        State2;</span><br><span class="line">    #iq&#123;type = set, sub_els = [_]&#125; -&gt;</span><br><span class="line">        <span class="keyword">try</span> xmpp:try_subtag(Pkt2, #xmpp_session&#123;&#125;) <span class="keyword">of</span></span><br><span class="line">        #xmpp_session&#123;&#125; -&gt;</span><br><span class="line">            send(State2, xmpp:make_iq_result(Pkt2));</span><br><span class="line">        _ -&gt;</span><br><span class="line">            check_privacy_then_route(State2, Pkt2)</span><br><span class="line">        <span class="keyword">catch</span> _:&#123;xmpp_codec, Why&#125; -&gt;</span><br><span class="line">            Txt = xmpp:io_format_error(Why),</span><br><span class="line">            Lang = maps:get(lang, State),</span><br><span class="line">            Err = xmpp:err_bad_request(Txt, Lang),</span><br><span class="line">            send_error(State2, Pkt2, Err)</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">    #presence&#123;to = #jid&#123;luser = LUser, lserver = LServer,</span><br><span class="line">                lresource = &lt;&lt;<span class="string">""</span>&gt;&gt;&#125;&#125; -&gt;</span><br><span class="line">        process_self_presence(State2, Pkt2);</span><br><span class="line">    #presence&#123;&#125; -&gt;</span><br><span class="line">        process_presence_out(State2, Pkt2);</span><br><span class="line">    _ -&gt;</span><br><span class="line">        <span class="comment">%路由逻辑 -&gt; ejabberd_router:route -&gt; ejabberd_router:do_route:353 -&gt; ejabberd_local:do_route:142 local route  -&gt; ejabberd_sm:do_route:693 processing IQ to bare JID -&gt;  gen_iq_handler:handle</span></span><br><span class="line">        check_privacy_then_route(State2, Pkt2)</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>
<p>gen_iq_handler:handle:76</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">handle</span><span class="params">(Component,</span></span></span><br><span class="line"><span class="function"><span class="params">       #iq&#123;to = To, type = T, lang = Lang, sub_els = [El]&#125; = Packet)</span></span></span><br><span class="line">  when T == get; T == set -&gt;</span><br><span class="line">    XMLNS = xmpp:get_ns(El),</span><br><span class="line">    Host = To#jid.lserver,</span><br><span class="line">    <span class="keyword">case</span> ets:lookup(Component, &#123;Host, XMLNS&#125;) <span class="keyword">of</span></span><br><span class="line">    [&#123;_, Module, Function&#125;] -&gt;</span><br><span class="line">        <span class="comment">%根据iq注册的名字空间，调用响应的mod模块实现，可以参照mod_echo，最终将type为set、get的请求处理结果发送到ejabberd_router:route(ResIQ)</span></span><br><span class="line">        process_iq(Host, Module, Function, Packet);</span><br><span class="line">    [] -&gt;</span><br><span class="line">        Txt = &lt;&lt;<span class="string">"No module is handling this query"</span>&gt;&gt;,</span><br><span class="line">        Err = xmpp:err_service_unavailable(Txt, Lang),</span><br><span class="line">        ejabberd_router:route_error(Packet, Err)</span><br><span class="line">    <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
</div></article></div><div class="right-container"><div class="widget"><div class="category"><h4>分类归档</h4><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CTI呼叫中心/">CTI呼叫中心</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/协议/">协议</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/开发工具/">开发工具</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/开发语言/">开发语言</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/开源框架/">开源框架</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/系统/">系统</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/账号/">账号</a><span class="category-list-count">1</span></li></ul></div></div><div class="widget"><div class="tagcloud"><h4>标签云</h4><a href="/tags/Freeswitch/" style="font-size: 10px;">Freeswitch</a> <a href="/tags/IVR知识/" style="font-size: 10px;">IVR知识</a> <a href="/tags/Mac-iTerm/" style="font-size: 10px;">Mac iTerm</a> <a href="/tags/RPC/" style="font-size: 10px;">RPC</a> <a href="/tags/VOIP/" style="font-size: 10px;">VOIP</a> <a href="/tags/ejabberd/" style="font-size: 10px;">ejabberd</a> <a href="/tags/erlang/" style="font-size: 20px;">erlang</a> <a href="/tags/erlang异常错误编程样式/" style="font-size: 10px;">erlang异常错误编程样式</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/idea/" style="font-size: 10px;">idea</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/linux-sysctl/" style="font-size: 15px;">linux-sysctl</a> <a href="/tags/linux-vimdiff/" style="font-size: 10px;">linux-vimdiff</a> <a href="/tags/rabbitmq/" style="font-size: 10px;">rabbitmq</a> <a href="/tags/rabbitmq安装/" style="font-size: 10px;">rabbitmq安装</a> <a href="/tags/rabbitmq集群/" style="font-size: 10px;">rabbitmq集群</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/redis集群/" style="font-size: 10px;">redis集群</a> <a href="/tags/voip/" style="font-size: 10px;">voip</a> <a href="/tags/账号/" style="font-size: 10px;">账号</a></div></div><div class="widget"><div class="recent"><h4>最近文章</h4><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/03/07/ejabberd19.2安装/">ejabberd源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/06/erlang19.3安装/">erlang19.3</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/02/ejabberd编码风格/">ejabberd编码风格</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/23/Freeswitch事件/">Freeswitch事件</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/23/VOIP名词/">VOIP名词</a></li></ul></div></div><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2019/03/06/erlang19.3安装/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2019 <a target="_blank"></a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a></p><p>闽ICP备16007301号-2</p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="http://apps.bdimg.com/libs/jquery/1.8.2/jquery.min.js"></script><script src="https://cdn1.lncld.net/static/js/av-mini-0.6.10.js"></script><script src="/scripts/hit-kounter-lc-0.2.0.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>